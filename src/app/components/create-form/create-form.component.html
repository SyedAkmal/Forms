<div *ngIf="!showFormEditor">
  <h2>Saved Forms</h2>
  <ul>
    <li *ngFor="let form of forms">
      {{ form.formName }}
      <button (click)="openForm(form)">Fill/Edit</button>
    </li>
  </ul>
  <div *ngIf="forms.length === 0">No saved forms found.</div>
</div>

<div *ngIf="showFormEditor && selectedForm">
  <h2>Fill/Edit Form: {{ selectedForm.formName }}</h2>

  <!-- ACTION BUTTONS: Top toolbar -->
  <div class="form-action-toolbar">
    <ng-container *ngIf="!showNameInput">
      <button mat-raised-button color="primary" type="button" (click)="showNameInput = true">
        Save
      </button>
    </ng-container>
 
  

    <ng-container *ngIf="showNameInput">
      <input
        type="text"
        [(ngModel)]="filledDataName"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Enter form name"
        required
        [ngClass]="{ invalid: nameError }"
        (keydown.enter)="$event.preventDefault()" />

      <button mat-stroked-button color="primary" type="button" (click)="confirmSaveFilledForm()">Confirm</button>
      <button mat-button type="button" (click)="cancelSave()">Cancel</button>

      <div *ngIf="nameError" class="error-message">Please enter a valid name.</div>
    </ng-container>

    <button mat-button type="button" (click)="closeForm()">Back</button>

    <ng-container *ngIf="isLoadedFromDashboard">
      <button mat-raised-button color="accent" (click)="exportToPDF()">Download as PDF</button>
    </ng-container>
  </div>

  <div id="form-to-export">
    <form id="dynamicForm" #formRef="ngForm" novalidate>

      <div *ngFor="let page of selectedForm.formPages; let p = index" class="page-container">
        <h3>Page {{ p + 1 }}</h3>

        <!-- Container with relative positioning -->
        <div [style.position]="'relative'" [style.minHeight.px]="containerHeight" style="padding: 8px;">
          <div class="form-page-container">
            <div *ngFor="let field of page.fields" class="field-wrapper"
       [ngStyle]="
             field.id === 'description'
                  ? {
        position: 'relative',
        width: field.width ? field.width + 'px' : '100%',
        padding: '8px',
        border: '1px solid #ccc',
        background: '#fafafa',
        boxSizing: 'border-box',
        marginBottom: '1rem',
        left: null,
        top: null
      }
    : {
        position: 'absolute',
        left: (field.position?.x || 0) + 'px',
        top: (field.position?.y || 0) + 'px',
        width: (field.width || 300) + 'px',
        padding: '8px',
        border: '1px solid #ccc',
        background: '#fafafa',
        boxSizing: 'border-box'
      }
"
            >

              <label [attr.for]="field.id" style="display: block; margin-bottom: 4px;">
                {{ field.label }}
                <span *ngIf="field.required" style="color: red;">*</span>
              </label>

              <!-- Text-like inputs -->
              <ng-container *ngIf="['text', 'email', 'number', 'tel', 'date'].includes(field.type || '')">
                <input
                  [type]="field.type"
                  [(ngModel)]="field.value"
                  [name]="field.id"
                  [id]="field.id"
                  [required]="!!field.required"
                  #inputRef="ngModel"
                  style="width: 100%;"
                />
                <div *ngIf="inputRef.invalid && (inputRef.dirty || inputRef.touched)" style="color: red;">
                  This field is required.
                </div>
              </ng-container>
             <ng-container *ngIf="field.type === 'project-title'">
  <input
    type="text"
    [(ngModel)]="field.value"
    [name]="field.id"
    [id]="field.id"
    placeholder="Enter project name"
    style="width: 100%;"
    required
  />
</ng-container> 

 <!-- Textarea -->
<ng-container *ngIf="field.type === 'textarea'">
  <textarea
    [(ngModel)]="field.value"
    [name]="field.id"
    [id]="field.id"
    [required]="!!field.required"
    #textareaRef="ngModel"
    [ngClass]="field.id === 'description' ? 'textarea-resizable-both' : 'textarea-resizable-vertical'"
  ></textarea>

  <div *ngIf="textareaRef.invalid && (textareaRef.dirty || textareaRef.touched)" style="color: red;">
    This field is required.
  </div>
</ng-container>

              <!-- Select -->
              <ng-container *ngIf="field.type === 'branch' && field.options">
                <select
                  [(ngModel)]="field.value"
                  [name]="field.id"
                  [id]="field.id"
                  [required]="!!field.required"
                  #selectRef="ngModel"
                  style="width: 100%;"
                >
                  <option value="">-- Select --</option>
                  <option *ngFor="let opt of field.options" [value]="opt.value">
                    {{ opt.label }}
                  </option>
                </select>
                <div *ngIf="selectRef.invalid && (selectRef.dirty || selectRef.touched)" style="color: red;">
                  This field is required.
                </div>
              </ng-container>

              <!-- Radio buttons -->
              <div *ngIf="field.type === 'radio' && field.options" style="margin-top: 4px;">
                <label *ngFor="let opt of field.options" style="margin-right: 10px;">
                  <input
                    type="radio"
                    [name]="field.id"
                    [value]="opt.value"
                    [(ngModel)]="field.value"
                    [required]="!!field.required"
                  />
                  {{ opt.label }}
                </label>
                <div
                  *ngIf="
                    formRef.controls[field.id]?.invalid &&
                    (formRef.controls[field.id]?.dirty || formRef.controls[field.id]?.touched)
                  "
                  style="color: red;"
                >
                  This field is required.
                </div>
              </div>

              <!-- File Upload -->
              <ng-container *ngIf="field.type === 'file'">
                <input type="file" accept="image/*" (change)="onFileSelected($event, field)" />
                <img
                  *ngIf="field.value"
                  [src]="field.value"
                  alt="Uploaded photo"
                  style="max-width: 100%; margin-top: 8px;"
                />
              </ng-container>

              <!-- Signature field -->
              <div *ngIf="field.type === 'signature'">
                <canvas
                  #canvas
                  [attr.data-id]="field.id"
                  width="400"
                  height="150"
                  style="border: 1px solid #000; touch-action: none; display: block; margin-top: 4px;"
                  (pointerdown)="startDrawing($event, field.id)"
                  (pointermove)="draw($event, field.id)"
                  (pointerup)="stopDrawing($event, field.id)"
                  (pointerleave)="stopDrawing($event, field.id)"
                ></canvas>
                <button type="button" (click)="clearSignatureCanvas(field.id)" style="margin-top: 4px;">
                  Clear Signature
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>

    </form>
  </div>
</div>