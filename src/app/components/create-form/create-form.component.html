<!-- TOP ACTIONS -->
<mat-toolbar color="primary" class="topbar">
  <span class="toolbar-title">Dashboard</span>
  <span class="spacer"></span>
</mat-toolbar>

<!-- ===== LIST VIEW ===== -->
<div *ngIf="!showFormEditor" class="templates-container page">

  <div class="page-header-row">
    <h2 class="page-title">Forms</h2>

    <div class="actions-row">
      <div class="pill-tabs">
        <button
          mat-raised-button
          class="tab-btn tofill"
          [class.active]="viewMode==='tofill'"
          (click)="showFormsToFill()">
          <mat-icon>assignment</mat-icon>
          Forms to Fill
        </button>

        <button
          type="button"
          class="tab-btn filled"
          [class.active]="viewMode==='filled'"
          (click)="showFilledForms()">
          <mat-icon class="tab-icon">inventory_2</mat-icon>
          <span>Filled Forms</span>
        </button>
      </div>

      <button mat-flat-button color="primary" (click)="loadForms()">
        <mat-icon>folder</mat-icon>
        Load Local
      </button>

      <button mat-flat-button color="accent" (click)="loadFormsFromFirebase()">
        <mat-icon>cloud_download</mat-icon>
        Load Firebase
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <mat-card *ngIf="viewMode==='default' && (!forms || !forms.length)" class="section-card empty-card">
    <mat-card-content class="empty">
      <mat-icon class="empty__icon">inbox</mat-icon>
      <div class="empty__title">No templates yet</div>
      <div class="empty__subtitle">Load from LocalStorage or Firebase to get started.</div>
    </mat-card-content>
  </mat-card>

  <!-- Templates to fill -->
  <ng-container *ngIf="viewMode === 'tofill' && templates?.length">
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>Forms to Fill</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <ul class="forms-list">
          <li class="form-row" *ngFor="let form of templates; trackBy: trackByFormId">
            <div class="left">
              <mat-icon class="doc">description</mat-icon>
              <div class="meta">
                <div class="name" [title]="form.formName">{{ form.formName || 'Untitled Template' }}</div>
                <div class="sub">Template</div>
              </div>
            </div>
            <div class="actions">
              <button mat-icon-button matTooltip="Fill" aria-label="Fill"
                      (click)="$event.stopPropagation(); openForm(form)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Download" aria-label="Download"
                      (click)="$event.stopPropagation(); onClickDownloadIcon(form)">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" aria-label="Delete"
                      (click)="$event.stopPropagation(); deleteForm(form)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </li>
        </ul>
      </mat-card-content>
    </mat-card>
  </ng-container>

  <!-- Filled forms -->
  <ng-container *ngIf="viewMode === 'filled'">
    <mat-card *ngIf="filledForms?.length; else noFilled" class="section-card forms-card">
      <mat-card-header>
        <mat-card-title>Filled Forms</mat-card-title>
        <span class="spacer"></span>
      </mat-card-header>

      <mat-card-content>
        <ul class="forms-list">
          <li class="form-row" *ngFor="let form of filledForms">
            <div class="left">
              <mat-icon class="doc filled">assignment</mat-icon>
              <div class="meta">
                <div class="name" [title]="form.formName">{{ form.formName || 'Untitled Filled Form' }}</div>
                <div class="sub">Filled</div>
              </div>
            </div>
            <div class="actions">
              <button mat-icon-button matTooltip="Open" aria-label="Open"
                      (click)="$event.stopPropagation(); openForm(form)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Download" aria-label="Download"
                      (click)="$event.stopPropagation(); onClickDownloadIcon(form)"
                      [disabled]="downloading.has(asKey(form.formId))">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" aria-label="Delete"
                      (click)="$event.stopPropagation(); deleteForm(form)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </li>
        </ul>
      </mat-card-content>
    </mat-card>

    <ng-template #noFilled>
      <mat-card class="section-card empty-card">
        <mat-card-content class="empty">
          <mat-icon class="empty__icon">inbox</mat-icon>
          <div class="empty__title">No filled forms yet</div>
          <div class="empty__subtitle">Click “Load Firebase” or “Load Local”.</div>
        </mat-card-content>
      </mat-card>
    </ng-template>
  </ng-container>

</div>

<!-- ===== EDITOR VIEW ===== -->
<div *ngIf="showFormEditor && selectedForm" class="view-root editor-content">

  <mat-toolbar class="editor-toolbar" color="primary">
    <button mat-icon-button (click)="closeForm()" aria-label="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="toolbar-title">Fill/Edit: {{ selectedForm.formName }}</span>
    <span class="spacer"></span>
<ng-container *ngIf="selectedForm as sf">
  <button
    *ngIf="sf.source === 'filled'"
    mat-icon-button
    [disabled]="isDownloading(sf.formId)"
    [matTooltip]="pdfTooltip(sf)"
    (click)="$event.stopPropagation(); onClickDownloadIcon(sf)"
    aria-label="Download PDF"
  >
    <mat-icon [class.spin]="isDownloading(sf.formId)">
      {{ hasPdf(sf) ? 'download' : 'picture_as_pdf' }}
    </mat-icon>
  </button>
</ng-container>
  </mat-toolbar>

  <!-- Inline naming / save bar -->
  <div class="form-action-toolbar">
    <ng-container *ngIf="!showNameInput">
      <button mat-raised-button color="primary" type="button" (click)="savePDFPreview()">
        <mat-icon>save</mat-icon>
        Save
      </button>
    </ng-container>

    <ng-container *ngIf="showNameInput">
      <mat-form-field appearance="outline">
        <mat-label>Enter form name</mat-label>
        <input matInput [(ngModel)]="filledDataName" [ngModelOptions]="{ standalone: true }" required />
        <mat-error *ngIf="nameError">Please enter a valid name.</mat-error>
      </mat-form-field>

      <button mat-stroked-button color="primary" type="button" (click)="confirmSaveFilledForm()">
        Confirm
      </button>
      <button mat-button type="button" (click)="cancelSave()">Cancel</button>
    </ng-container>
  </div>

  <!-- Dialog template -->
  <ng-template #saveLoadChoiceTpl let-data>
    <h2 mat-dialog-title>{{ data?.mode === 'save' ? 'Choose Save Location' : 'Load From' }}</h2>
    <mat-dialog-content>
      <p *ngIf="data?.mode === 'save'">Where do you want to save?</p>
      <p *ngIf="data?.mode === 'load'">Where do you want to load from?</p>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button [mat-dialog-close]="null" cdkFocusInitial>Cancel</button>
      <button mat-raised-button color="primary" [mat-dialog-close]="'firebase'">Firebase</button>
      <button mat-button [mat-dialog-close]="'local'">Local storage</button>
      <button mat-button *ngIf="data?.mode === 'save'" [mat-dialog-close]="'both'">Both</button>
    </mat-dialog-actions>
  </ng-template>

  <!-- FORM CANVAS -->
  <div class="editor-scroll">
    <mat-card class="editor-card">
      <mat-card-content>

        <canvas #pdfCanvas style="display:none"></canvas>

        <div id="form-to-export" class="form-export-surface">
          <form id="dynamicForm" #formRef="ngForm" novalidate>

            <div *ngFor="let page of selectedForm.formPages; let p = index" class="page-container">
              <div class="page-header">
                <span class="page-title">Page {{ p + 1 }}</span>
              </div>

              <div class="page-surface" style="position: relative" [style.minHeight.px]="getPageHeight(page)">
                <div class="form-page-container">

                  <!-- FIELD -->
                  <div *ngFor="let field of page.fields"
                       class="field-wrapper"
                       [attr.data-id]="field.id"
                       [ngStyle]="getFieldStyle(field)"
                       (mousedown)="onWrapperMouseDown($event, field)">

                    <label class="field-label" [attr.for]="field.id" [attr.id]="field.id + '__label'">
                      {{ field.label }} <span *ngIf="field.required" class="req">*</span>
                    </label>

                    <!-- Text-like -->
                    <ng-container
                      *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'number' || field.type === 'tel' || field.type === 'date' || !field.type">
                      <input [type]="field.type || 'text'"
                             [(ngModel)]="field.value"
                             [name]="field.id" [id]="field.id"
                             [required]="!!field.required"
                             #inputRef="ngModel" style="width:100%" />
                      <mat-error *ngIf="inputRef.invalid && (inputRef.dirty || inputRef.touched)">
                        This field is required.
                      </mat-error>
                    </ng-container>
     <ng-container *ngIf="field.type === 'checkbox'">
  <div class="checkbox-group"
       role="group"
       [attr.aria-labelledby]="field.id + '__label'">

    <mat-checkbox
      *ngFor="let opt of (field.options || []); let i = index"
      [(ngModel)]="opt.checked"
      [ngModelOptions]="{ standalone: true }"
      [attr.id]="field.id + '_chk_' + i"
      (ngModelChange)="onCheckboxToggle(field)">
      {{ opt.label }}
    </mat-checkbox>
  </div>

  <!-- no arrow functions in templates -->
  <div *ngIf="field.required && !hasAnyChecked(field)"
       style="color:#d32f2f; font-size:12px;">
    * Required: select at least one option.
  </div>
</ng-container>

                    <!-- Project Title -->
                    <ng-container *ngIf="field.type === 'project-title'">
                      <input type="text" [(ngModel)]="field.value" [name]="field.id" [id]="field.id"
                             placeholder="Enter project name" required class="w-100" />
                    </ng-container>

                    <!-- Textarea / Description -->
                    <ng-container *ngIf="field.type === 'textarea' || field.type === 'description'">
                      <ng-container *ngIf="isDescriptionField(field); else normalTextarea">
                        <div style="display:flex; justify-content:flex-end; margin-bottom:6px;">
                          <button mat-stroked-button color="primary" type="button" (click)="addProblemItem(field)">
                            Add problem
                          </button>
                        </div>

                        <div style="display:flex; flex-direction:column; gap:6px;">
                          <div *ngFor="let item of (field.problemItems || []); let i = index"
                               style="display:flex; align-items:center; gap:8px;">
                            <span style="width:24px; text-align:right;">{{ item.no }}.</span>

                            <textarea class="desc-input"
                                      [ngModel]="item.text"
                                      (ngModelChange)="updateProblemText(field, i, $event)"
                                      [ngModelOptions]="{ standalone: true }"
                                      placeholder="Write problem description..."
                                      style="flex:0 0 auto; display:block; min-width:140px; min-height:60px; max-width:none; max-height:none; padding:4px; border:1px solid #ccc; border-radius:4px; resize:both; overflow:auto;"></textarea>

                            <button mat-icon-button type="button" (click)="removeProblemItem(field, i)" aria-label="Remove">
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        </div>
                      </ng-container>

                      <ng-template #normalTextarea>
                        <textarea [(ngModel)]="field.value" [name]="field.id" [id]="field.id"
                                  class="textarea-resizable-both"
                                  [placeholder]="field.placeholder || ''"
                                  style="min-height:60px; resize:both; overflow:auto;"></textarea>
                      </ng-template>
                    </ng-container>

                    <!-- Select -->
                    <ng-container *ngIf="field.type === 'branch' && field.options">
                      <mat-form-field appearance="fill" class="w-100">
                        <mat-label>Select</mat-label>
                        <mat-select [(ngModel)]="field.value" [name]="field.id" [id]="field.id"
                                    [required]="!!field.required" #selectRef="ngModel">
                          <mat-option [value]="''">-- Select --</mat-option>
                          <mat-option *ngFor="let opt of field.options" [value]="opt.value">
                            {{ opt.label }}
                          </mat-option>
                        </mat-select>
                        <mat-error *ngIf="selectRef.invalid && (selectRef.dirty || selectRef.touched)">
                          This field is required.
                        </mat-error>
                      </mat-form-field>
                    </ng-container>

                    <!-- Radio -->
                    <div *ngIf="field.type === 'radio' && field.options"
                         class="radio-group"
                         role="radiogroup"
                         [attr.aria-labelledby]="field.id + '__label'">
                      <label *ngFor="let opt of field.options; let i = index"
                             class="radio-option"
                             [attr.for]="field.id + '_opt_' + i">
                        <input type="radio"
                               [id]="field.id + '_opt_' + i"
                               [name]="field.id"
                               [value]="opt.value"
                               [(ngModel)]="field.value"
                               [required]="!!field.required">
                        {{ opt.label }}
                      </label>
                    </div>

                    <!-- File -->
                    <ng-container *ngIf="field.type === 'file'">
                      <input type="file" accept="image/*" (change)="onFileSelected($event, field)" />
                      <img *ngIf="field.value" [src]="field.value" alt="Uploaded photo" class="uploaded-img" />
                    </ng-container>

                    <!-- Signature -->
                    <div *ngIf="field.type === 'signature'">
                      <canvas #canvas
                              [attr.data-id]="field.id"
                              width="400" height="150"
                              class="signature-canvas"
                              (pointerdown)="startDrawing($event, field.id)"
                              (pointermove)="draw($event, field.id)"
                              (pointerup)="stopDrawing($event, field.id)"
                              (pointerleave)="stopDrawing($event, field.id)">
                      </canvas>

                      <button mat-stroked-button type="button" data-nonprint (click)="clearSignatureCanvas(field.id)">
                        Clear Signature
                      </button>
                    </div>

                  </div>
                  <!-- /FIELD -->

                </div>
              </div>
            </div>

          </form>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>