<!-- TOP ACTIONS -->
<mat-toolbar color="primary" class="topbar">
  <span class="toolbar-title">Dashboard</span>
  <span class="spacer"></span>
</mat-toolbar>

<!-- ===== LIST VIEW ===== -->
<div *ngIf="!showFormEditor" class="templates-container">

  <div class="actions-row">
    <button mat-stroked-button color="primary" (click)="loadForms()">
      <mat-icon>folder</mat-icon>
      Load Local
    </button>
    <button mat-raised-button color="accent" (click)="loadFormsFromFirebase()">
      <mat-icon>cloud_download</mat-icon>
      Load Firebase
    </button>
  </div>

  <!-- Empty state -->
  <mat-card *ngIf="!forms || !forms.length" class="section-card empty-card">
    <mat-card-content class="empty">
      <mat-icon class="empty__icon">inbox</mat-icon>
      <div class="empty__title">No saved forms found</div>
      <div class="empty__subtitle">Load from LocalStorage or Firebase to get started.</div>
    </mat-card-content>
  </mat-card>

<!-- TEMPLATES -->
<mat-card *ngIf="forms && forms.length" class="section-card templates-block">

  <!-- centered title with thin underline -->
<div class="tpl-row">
  <span class="tpl-label">Templates</span>

  <mat-form-field appearance="outline" class="tpl-search">
    <mat-label>Search templates</mat-label>
    <!-- no ngModel; purely local -->
    <input #tplSearch matInput placeholder="Search templates" />
    <button *ngIf="tplSearch.value" mat-icon-button matSuffix (click)="tplSearch.value=''">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>

  <button mat-icon-button class="tpl-plus" (click)="onAddTemplate()" aria-label="Add Template">
    <mat-icon>add</mat-icon>
  </button>
</div>

  <mat-card-content>
    <div class="forms-grid">
      <ng-container *ngFor="let form of forms">
        <mat-card class="form-tile" *ngIf="form.source === 'template'">
          <div class="tile-head">
            <div class="tile-title">
              <mat-icon>description</mat-icon>
              <div class="texts">
                <div class="name">{{ form.formName || 'Untitled Template' }}</div>
                <div class="meta">Template</div>
              </div>
            </div>

            <div class="tile-actions">
              <button mat-icon-button (click)="openForm(form)" aria-label="Fill or Edit">
                <mat-icon>edit</mat-icon>
              </button>

              <button
                mat-icon-button
                (click)="onPdfClick(form)"
               [disabled]="downloading.has(asKey(form.formId))">
                <mat-icon>download</mat-icon>
              </button>

              <button mat-icon-button color="warn" (click)="deleteForm(form)" aria-label="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-card>
      </ng-container>
    </div>
  </mat-card-content>
</mat-card>

  <!-- FILLED FORMS -->
  <mat-card *ngIf="forms && forms.length" class="section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assignment_turned_in</mat-icon>
        <span>Filled Forms</span>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="forms-grid">
        <ng-container *ngFor="let form of forms">
          <mat-card class="form-tile" *ngIf="form.source === 'filled'">
            <div class="tile-head">
              <div class="tile-title">
                <mat-icon color="accent">assignment</mat-icon>
                <div class="texts">
                  <div class="name">{{ form.formName || 'Untitled Filled Form' }}</div>
                  <div class="meta">Filled</div>
                </div>
              </div>

              <div class="tile-actions">
                <button mat-icon-button (click)="openForm(form)" aria-label="Open">
                  <mat-icon>edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  (click)="onPdfClick(form)"
                  [disabled]="downloading.has(asKey(form.formId))">
                  <mat-icon>download</mat-icon>
                </button>

                <button mat-icon-button color="warn" (click)="deleteForm(form)" aria-label="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-card>
        </ng-container>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- ===== EDITOR VIEW ===== -->
<div *ngIf="showFormEditor && selectedForm" class="view-root editor-content">

  <mat-toolbar class="editor-toolbar" color="primary">
    <button mat-icon-button (click)="closeForm()" aria-label="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="toolbar-title">Fill/Edit: {{ selectedForm.formName }}</span>
    <span class="spacer"></span>
    <button mat-raised-button color="accent" (click)="exportToPDF()">
      <mat-icon>picture_as_pdf</mat-icon>
      Download PDF
    </button>
  </mat-toolbar>

  <!-- Inline naming / save bar -->
  <div class="form-action-toolbar">
    <ng-container *ngIf="!showNameInput">
      <button mat-raised-button color="primary" type="button" (click)="savePDFPreview()">
        <mat-icon>save</mat-icon>
        Save
      </button>
    </ng-container>

    <ng-container *ngIf="showNameInput">
      <mat-form-field appearance="outline">
        <mat-label>Enter form name</mat-label>
        <input matInput [(ngModel)]="filledDataName" [ngModelOptions]="{ standalone: true }" required />
        <mat-error *ngIf="nameError">Please enter a valid name.</mat-error>
      </mat-form-field>

      <button mat-stroked-button color="primary" type="button" (click)="confirmSaveFilledForm()">
        Confirm
      </button>
      <button mat-button type="button" (click)="cancelSave()">Cancel</button>
    </ng-container>
  </div>

  <!-- Dialog template -->
  <ng-template #saveLoadChoiceTpl let-data>
    <h2 mat-dialog-title>{{ data?.mode === 'save' ? 'Choose Save Location' : 'Load From' }}</h2>
    <mat-dialog-content>
      <p *ngIf="data?.mode === 'save'">Where do you want to save?</p>
      <p *ngIf="data?.mode === 'load'">Where do you want to load from?</p>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button [mat-dialog-close]="null" cdkFocusInitial>Cancel</button>
      <button mat-raised-button color="primary" [mat-dialog-close]="'firebase'">Firebase</button>
      <button mat-button [mat-dialog-close]="'local'">Local storage</button>
      <button mat-button *ngIf="data?.mode === 'save'" [mat-dialog-close]="'both'">Both</button>
    </mat-dialog-actions>
  </ng-template>

  <!-- FORM CANVAS -->
  <mat-card class="editor-card">
    <mat-card-content>

      <canvas #pdfCanvas style="display:none"></canvas>

      <div id="form-to-export" class="form-export-surface">
        <form id="dynamicForm" #formRef="ngForm" novalidate>

          <div *ngFor="let page of selectedForm.formPages; let p = index" class="page-container">
            <div class="page-header">
              <span class="page-title">Page {{ p + 1 }}</span>
            </div>

            <div class="page-surface" style="position: relative" [style.minHeight.px]="containerHeight">
              <div class="form-page-container">

                <!-- FIELD -->
                <div *ngFor="let field of page.fields"
                     class="field-wrapper"
                     [attr.data-id]="field.id"
                     [ngStyle]="getFieldStyle(field)">

                  <label class="field-label" [attr.for]="field.id" [attr.id]="field.id + '__label'">
                    {{ field.label }} <span *ngIf="field.required" class="req">*</span>
                  </label>

                  <!-- Text-like inputs (no array.includes) -->
                  <ng-container *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'number' || field.type === 'tel' || field.type === 'date' || !field.type">
                    <input
                      [type]="field.type || 'text'"
                      [(ngModel)]="field.value"
                      [name]="field.id"
                      [id]="field.id"
                     [required]="!!field.required"
                      #inputRef="ngModel"
                      class="w-100" />
                    <mat-error *ngIf="inputRef.invalid && (inputRef.dirty || inputRef.touched)">
                      This field is required.
                    </mat-error>
                  </ng-container>

                  <!-- Project Title -->
                  <ng-container *ngIf="field.type === 'project-title'">
                    <input type="text"
                           [(ngModel)]="field.value"
                           [name]="field.id"
                           [id]="field.id"
                           placeholder="Enter project name"
                           required
                           class="w-100" />
                  </ng-container>

                  <!-- Textarea -->
                  <ng-container *ngIf="field.type === 'textarea'">
                    <textarea
                      #autoGrowTextarea
                      [(ngModel)]="field.value"
                      [name]="field.id"
                      [id]="field.id"
                        [required]="!!field.required"
                      #textareaRef="ngModel"
                      class="textarea-resizable-both"
                      [attr.aria-describedby]="field.id + '-error'"
                      [placeholder]="field.placeholder || ''"
                      style="min-height: 60px"></textarea>
                    <mat-error *ngIf="textareaRef.invalid && (textareaRef.dirty || textareaRef.touched)"
                               [id]="field.id + '-error'">
                      This field is required.
                    </mat-error>
                  </ng-container>

                  <!-- Select -->
                  <ng-container *ngIf="field.type === 'branch' && field.options">
                    <mat-form-field appearance="fill" class="w-100">
                      <mat-label>Select</mat-label>
                      <mat-select
                        [(ngModel)]="field.value"
                        [name]="field.id"
                        [id]="field.id"
                        [required]="!!field.required"
                        #selectRef="ngModel">
                        <mat-option [value]="''">-- Select --</mat-option>
                        <mat-option *ngFor="let opt of field.options" [value]="opt.value">
                          {{ opt.label }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="selectRef.invalid && (selectRef.dirty || selectRef.touched)">
                        This field is required.
                      </mat-error>
                    </mat-form-field>
                  </ng-container>

                  <!-- Radio -->
                  <div *ngIf="field.type === 'radio' && field.options"
                       class="radio-group"
                       role="radiogroup"
                       [attr.aria-labelledby]="field.id + '__label'">

                    <label *ngFor="let opt of field.options; let i = index"
                           class="radio-option"
                           [attr.for]="field.id + '_opt_' + i">
                      <input
                        type="radio"
                        [id]="field.id + '_opt_' + i"
                        [name]="field.id"
                        [value]="opt.value"
                        [(ngModel)]="field.value"
                       [required]="!!field.required">
                      {{ opt.label }}
                    </label>
                  </div>

                  <!-- File -->
                  <ng-container *ngIf="field.type === 'file'">
                    <input type="file" accept="image/*" (change)="onFileSelected($event, field)" />
                    <img *ngIf="field.value" [src]="field.value" alt="Uploaded photo" class="uploaded-img" />
                  </ng-container>

                  <!-- Signature -->
                  <div *ngIf="field.type === 'signature'">
                    <canvas
                      #canvas
                      [attr.data-id]="field.id"
                      width="400"
                      height="150"
                      class="signature-canvas"
                      (pointerdown)="startDrawing($event, field.id)"
                      (pointermove)="draw($event, field.id)"
                      (pointerup)="stopDrawing($event, field.id)"
                      (pointerleave)="stopDrawing($event, field.id)">
                    </canvas>
                    <button mat-stroked-button type="button" (click)="clearSignatureCanvas(field.id)">
                      Clear Signature
                    </button>
                  </div>

                </div>
                <!-- /FIELD -->

              </div>
            </div>
          </div>

        </form>
      </div>
    </mat-card-content>
  </mat-card>
</div>