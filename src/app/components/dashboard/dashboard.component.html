<div class="dashboard-container">
  <!-- Top toolbar -->
  <mat-toolbar color="primary" class="toolbar">
    <span class="title">Dashboard</span>
    <span class="spacer"></span>
   <div class="action-bar">
    <button class="avatar-btn" mat-icon-button [matMenuTriggerFor]="userMenu">
      <mat-icon>account_circle</mat-icon>
    </button>

 <mat-menu #userMenu="matMenu">
    <button mat-menu-item disabled>
      <mat-icon>person</mat-icon>
      <span>{{ user?.displayName || user?.email || 'Signed in' }}</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="logout()">
      <mat-icon>logout</mat-icon>
      <span>Logout</span>
    </button>
  </mat-menu>

     <mat-form-field appearance="outline" class="plants pill">
    <mat-label>Select Plants</mat-label>
    <mat-select [(value)]="selectedPlants" multiple>
      <mat-option *ngFor="let p of (plants$ | async)" [value]="p.regoName">
        {{ p.plantName || p.regoName }}
      </mat-option>
    </mat-select>
  </mat-form-field>

     <button mat-flat-button class="btn-gradient" (click)="openAddPlantDialog($event)">
    <mat-icon>add</mat-icon>&nbsp;Add New Plant
  </button>

  <button mat-flat-button class="btn-ghost-warn" (click)="openAddUserDialog($event)">
    <mat-icon>person_add</mat-icon>&nbsp;Add New User
  </button>
</div>
  </mat-toolbar>

  <!-- Body: sidebar + content -->
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">Avante Forms</div>

      <button mat-button class="menu-button" routerLink="/template">
        <mat-icon>table_view</mat-icon>
        Templates
      </button>

      <button mat-button class="menu-button" routerLink="/forms">
        <mat-icon>description</mat-icon>
        Forms
      </button>

      <button mat-button class="menu-button" routerLink="/problem-tracker">
        <mat-icon>bug_report</mat-icon>
        Problem Tracker
      </button>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <!-- Welcome banner -->
    <div class="welcome-card">
  <mat-icon class="welcome-icon">campaign</mat-icon>
  <span>{{ welcomeMessages[branch] }}</span>
</div>

      <!-- Templates panel -->
      <mat-card class="templates-card">
        <div class="section-header">
          <span class="title">Templates</span>
          <span class="spacer"></span>

          <mat-form-field appearance="fill" class="search-box">
            <mat-label>Search templates</mat-label>
            <input matInput (keyup)="applyFilter($event)" />
            <button mat-icon-button matSuffix *ngIf="searchValue" (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>

          <button mat-icon-button (click)="createTemplate()" aria-label="Add template">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="table-wrap" *ngIf="dataSource?.data?.length; else noTemplates">
          <table mat-table [dataSource]="dataSource" class="mat-elevation-z1">

            <!-- Serial -->
            <ng-container matColumnDef="serial">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let row; let i = index">{{ i + 1 }}</td>
            </ng-container>

            <!-- Template (formName) -->
            <ng-container matColumnDef="template">
              <th mat-header-cell *matHeaderCellDef>Template</th>
              <td mat-cell *matCellDef="let row">{{ row.formName || 'Untitled' }}</td>
            </ng-container>

            <!-- Description -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let row">{{ row.description || '-' }}</td>
            </ng-container>

            <!-- Created At -->
            <ng-container matColumnDef="createdAt">
              <th mat-header-cell *matHeaderCellDef>Date Created</th>
              <td mat-cell *matCellDef="let row">{{ row.createdAt | date:'M/d/yy, h:mm a' }}</td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let row" class="actions">
                <button mat-icon-button matTooltip="Edit" (click)="openFormEditor(row)">
                  <mat-icon>edit</mat-icon>
                </button>

                <button mat-icon-button color="warn" matTooltip="Delete" (click)="deleteTemplate(row)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['serial','template','description','createdAt','actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['serial','template','description','createdAt','actions']"></tr>
          </table>
        </div>

        <ng-template #noTemplates>
          <div class="empty-tip">No templates yet. Click <strong>+</strong> to create one.</div>
        </ng-template>
      </mat-card>

      <!-- Forms / Filled Forms panel -->
    <mat-card class="forms-card" style="margin-top:16px;">
        <div class="section-header">
          <span class="title">Forms</span>
          <span class="spacer"></span>
        </div>

        <div class="table-wrap" *ngIf="filledForms?.length; else noForms">
          <table mat-table [dataSource]="filledForms" class="mat-elevation-z1">

            <!-- # -->
            <ng-container matColumnDef="idx">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let f; let i = index">{{ i + 1 }}</td>
            </ng-container>

            <!-- Form Name -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Form Name</th>
              <td mat-cell *matCellDef="let f">{{ f.name }}</td>
            </ng-container>

            <!-- Template -->
            <ng-container matColumnDef="templateName">
              <th mat-header-cell *matHeaderCellDef>Template</th>
              <td mat-cell *matCellDef="let f">{{ getFormNameById(f.formId) }}</td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let f" class="actions">
                <button mat-icon-button matTooltip="Open" (click)="openFilledForm(f)">
                  <mat-icon>open_in_new</mat-icon>
                </button>
              <button
      mat-icon-button
      [disabled]="isDownloading(f.formId)"
      [matTooltip]="pdfTooltip(f)"
      (click)="$event.stopPropagation(); downloadFilledFormPDF(f)">
      <mat-icon [class.spin]="isDownloading(f.formId)">
        {{ hasPdf(f) ? 'picture_as_pdf' : 'download' }}
      </mat-icon>
    </button>
                <button mat-icon-button color="warn" matTooltip="Delete" (click)="deleteFilledForm(f)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['idx','name','templateName','actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['idx','name','templateName','actions']"></tr>
          </table>
        </div>

        <ng-template #noForms>
          <div class="empty-tip">No forms yet. Fill a template to see it here.</div>
        </ng-template>
      </mat-card>
    </div>
  </div>
</div>