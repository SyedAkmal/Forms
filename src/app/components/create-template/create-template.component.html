<div class="form-builder-wrapper">
  <div class="top-section">
    <h2>Form Builder</h2>
    <div class="top-actions">
      <button mat-raised-button color="primary" (click)="backToDashboard()">Back to Dashboard</button>
      <button mat-raised-button color="primary" (click)="saveForm()">Save Form</button>
      <button mat-raised-button color="primary" (click)="exportToPDF()">Save as PDF</button>
      <button mat-raised-button color="accent" (click)="loadSavedFormsList()">Load Saved Forms</button>
    </div>
  </div>

  <!-- Saved Forms List -->
  <div *ngIf="formListVisible" class="saved-forms-list">
    <h2>Saved Forms</h2>
    <ul>
      <li *ngFor="let form of savedForms">
        <strong>{{ form.formName }}</strong>
        <button mat-raised-button color="primary" (click)="loadFormById(form.formId)">Edit</button>
      </li>
    </ul>
    <button mat-button color="warn" (click)="formListVisible = false; formBuilderVisible = true;">Back to Form Builder</button>
  </div>

  <!-- Form Builder Section -->
  <div *ngIf="formBuilderVisible" class="form-builder">
    <div class="main-content" cdkDropListGroup>

      <!-- Field Palette -->
      <div class="field-palette"
           cdkDropList
           id="fieldPalette"
           [cdkDropListData]="paletteFields"
           [cdkDropListConnectedTo]="['formCanvas']"
           (cdkDropListDropped)="onDrop($event)">
        <h3>Field Palette</h3>
        <div *ngFor="let field of paletteFields" class="field-item" cdkDrag [cdkDragData]="field" (cdkDragMoved)="onDragMoved($event)">
          <ng-container *cdkDragPreview>
            <div class="drag-preview">{{ field.label }}</div>
          </ng-container>
          {{ field.label }}
        </div>
      </div>

<div
  class="form-canvas"
  cdkDropList
  id="formCanvas"
  (cdkDropListDropped)="onDrop($event)"
  [cdkDropListConnectedTo]="['fieldPalette']"
  [cdkDropListData]="formPages[currentPage].fields"
  style="position: relative;"
>
  <div *ngFor="let field of formPages[currentPage].fields; let i = index; trackBy: trackByFieldId"
       cdkDrag
       [cdkDragData]="field"
       [cdkDragFreeDragPosition]="field.position || { x: 0, y: 0 }"
       [cdkDragBoundary]="'#formCanvas'"
       (cdkDragStarted)="onFieldDragStarted($event, field)"
       (cdkDragMoved)="onFieldDragMoved($event, field)"
       (cdkDragEnded)="onFieldDragEnded($event, field)"
       class="form-row"
       [style.left.px]="field.position?.x"
       [style.top.px]="field.position?.y"
       style="position: absolute; cursor: move; padding: 8px; border: 1px solid #ccc; background: #fafafa;"
  >



          <div cdkDragHandle class="drag-handle" style="cursor: move;">â˜°</div>

          <label *ngIf="field.type !== 'project-title'" class="form-label" [attr.for]="'field-' + i">{{ field.label }}</label>

          <ng-container [ngSwitch]="field.type">
            <!-- PROJECT TITLE -->
            <div *ngSwitchCase="'project-title'" class="form-input editable-div-wrapper" style="position: relative;">
              <!-- Hidden input to provide id/name for autofill & form -->
              <input type="hidden" id="field-{{i}}" name="field-{{i}}" [value]="field.value" />
              <div contenteditable="true" class="form-input editable-div"
                   (input)="onContentEditableInput($event, field)"
                   aria-label="Project Name" spellcheck="false" role="textbox" tabindex="0"
                   style="min-height: 24px; border: 1px solid #ccc; padding: 4px;">
                <span *ngIf="!field.value" class="placeholder">Enter project name</span>
                {{ field.value }}
              </div>
         </div>

            <!-- TEXT -->
            <input *ngSwitchCase="'text'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="text" 
                   [(ngModel)]="field.value" 
                   class="form-input" 
                   [style.width.px]="field.width" 
                   [placeholder]="field.placeholder || ''" />

            <!-- NUMBER -->
            <input *ngSwitchCase="'number'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="number" 
                   [(ngModel)]="field.value" 
                   class="form-input" 
                   [style.width.px]="field.width" 
                   [placeholder]="field.placeholder || ''" />

            <!-- TEL -->
            <input *ngSwitchCase="'tel'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="tel" 
                   [(ngModel)]="field.value" 
                   class="form-input" 
                   [style.width.px]="field.width" 
                   [placeholder]="field.placeholder || ''" />

            <!-- EMAIL -->
            <input *ngSwitchCase="'email'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="email" 
                   [(ngModel)]="field.value" 
                   class="form-input" 
                   [style.width.px]="field.width" 
                   [placeholder]="field.placeholder || ''" />

            <!-- ID (readonly) -->
            <input *ngSwitchCase="'id'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="text" 
                   disabled 
                   class="form-input" 
                   [style.width.px]="field.width" 
                   placeholder="ID Field (readonly)" />

            <!-- DATE -->
            <input *ngSwitchCase="'date'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="date" 
                   [(ngModel)]="field.value" 
                   class="form-input" 
                   [style.width.px]="field.width" />

            <!-- BRANCH (SELECT) -->
            <select *ngSwitchCase="'branch'" 
                    id="field-{{i}}" 
                    name="field-{{i}}" 
                    [(ngModel)]="field.value" 
                    class="form-input" 
                    [style.width.px]="field.width">
              <option *ngFor="let option of field.options || []" [value]="option.value">{{ option.label }}</option>
            </select>

            <!-- TEXTAREA -->
            <textarea *ngSwitchCase="'textarea'" 
                      id="field-{{i}}" 
                      name="field-{{i}}" 
                      [(ngModel)]="field.value" 
                      class="form-input" 
                      [style.width.px]="field.width" 
                      [placeholder]="field.placeholder || ''"></textarea>

            <!-- RADIO -->
            <div *ngSwitchCase="'radio'" class="form-input" [style.width.px]="field.width">
              <label *ngFor="let option of field.options || []" style="margin-right: 8px;">
                <input type="radio" 
                       [name]="'radio-' + i" 
                       [value]="option.value" 
                       [(ngModel)]="field.value" />
                {{ option.label }}
              </label>
            </div>

            <!-- FILE -->
            <input *ngSwitchCase="'file'" 
                   id="field-{{i}}" 
                   name="field-{{i}}" 
                   type="file" 
                   class="form-input" 
                   [style.width.px]="field.width" />

            <!-- EMPTY -->
            <div *ngSwitchCase="'empty'" [style.width.px]="field.width" style="height: 40px; border: 1px dashed #ccc;"></div>

            <!-- SUBMIT BUTTON -->
            <button *ngSwitchCase="'submit'" mat-raised-button color="primary" (click)="onSubmit()">
              {{ field.label || 'Submit' }}
            </button>

            <!-- SIGNATURE PAD -->
            <div *ngSwitchCase="'signature'" class="signature-pad-container form-input"
                 [style.width.px]="field.width" style="position: relative;">
              <canvas #canvasElement
                      [attr.data-id]="field.id"
                      [style.width.px]="field.width || 300"
                      [style.height.px]="150"
                      aria-label="Signature Pad">
              </canvas>

              <button mat-fab class="clear-sign-btn" aria-label="Clear signature"
                      style="position: absolute; top: 5px; right: 45px; z-index: 10;"
                      (click)="clearSignatureCanvas(field.id); $event.stopPropagation()">
                <mat-icon>clear</mat-icon>
              </button>
            </div>

            <!-- DEFAULT -->
            <div *ngSwitchDefault>Unsupported field type: {{ field.type }}</div>
          </ng-container>

          <button mat-fab aria-label="Remove field" class="delete-btn"
                  (click)="removeField(currentPage, field); $event.stopPropagation()">
            <mat-icon>delete</mat-icon>
          </button>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Field Configuration Modal -->
<div *ngIf="fieldConfigVisible" class="popup-overlay mat-dialog-overlay">
  <div class="popup mat-elevation-z4">
    <h3 class="form-title">Configure Field</h3>
    <form (ngSubmit)="createField()" #form="ngForm" class="field-form">

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Label</mat-label>
        <input matInput [(ngModel)]="newField.label" name="label" required />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Placeholder</mat-label>
        <input matInput [(ngModel)]="newField.placeholder" name="placeholder" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Width</mat-label>
        <mat-select [(ngModel)]="newField.width" name="width">
          <mat-option [value]="150">Small</mat-option>
          <mat-option [value]="300">Medium</mat-option>
          <mat-option [value]="400">Large</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="action-buttons">
        <button mat-raised-button color="primary" type="submit">Create</button>
        <button mat-button color="warn" type="button" (click)="cancelFieldConfig()">Cancel</button>
      </div>
    </form>
  </div>
</div>