<div class="form-builder-wrapper">
  <div class="top-section">
    <h2>Form Builder</h2>
    <div class="top-actions">
      <button mat-raised-button color="primary" (click)="backToDashboard()">Back to Dashboard</button>
      <button mat-raised-button color="primary" (click)="saveForm()">Save Form</button>
      <button mat-raised-button color="primary" (click)="exportToPDF()">Save as PDF</button>
      <button mat-raised-button color="accent" (click)="loadSavedFormsList()">Load Saved Forms</button>
    </div>
  </div>

  <!-- Saved Forms List -->
  <div *ngIf="formListVisible" class="saved-forms-list">
    <h2>Saved Forms</h2>
    <ul>
      <li *ngFor="let form of savedForms">
        <strong>{{ form.formName }}</strong>
        <button mat-raised-button color="primary" (click)="loadFormById(form.formId)">Edit</button>
      </li>
    </ul>
    <button mat-button color="warn" (click)="formListVisible = false; formBuilderVisible = true;">Back to Form Builder</button>
  </div>

  <!-- Form Builder UI -->
  <div *ngIf="formBuilderVisible" class="form-builder">
    <div class="main-content" cdkDropListGroup>

      <!-- Field Palette -->
      <div class="field-palette" cdkDropList id="fieldPalette"
           [cdkDropListData]="paletteFields"
           [cdkDropListConnectedTo]="['formCanvas']"
           (cdkDropListDropped)="drop($event)">
        <h3>Field Palette</h3>
        <div *ngFor="let field of paletteFields"
             class="draggable-field"
             cdkDrag
             [cdkDragData]="field">
          <ng-container *cdkDragPreview>
            <div class="drag-preview">{{ field.label }}</div>
          </ng-container>
          {{ field.label }}
        </div>
      </div>

      <!-- Form Canvas -->
      <div class="form-canvas" cdkDropList id="formCanvas"
           [cdkDropListData]="formPages[currentPage].fields"
           [cdkDropListConnectedTo]="['fieldPalette']"
           (cdkDropListDropped)="drop($event)">

        <div *ngFor="let field of formPages[currentPage].fields; let i = index; trackBy: trackByFieldId" 
     cdkDrag 
     [cdkDragData]="field" 
     class="form-row">

          <div cdkDragHandle class="drag-handle">â˜°</div>

          <!-- Hide label for project-title field -->
          <label *ngIf="field.type !== 'project-title'" class="form-label">{{ field.label }}</label>

          <ng-container [ngSwitch]="field.type">

            <!-- Project Title as editable div with placeholder -->
            <div *ngSwitchCase="'project-title'"
                 contenteditable="true"
                 class="form-input editable-div"
                 (input)="onContentEditableInput($event, field)"
                 [attr.data-placeholder]="'Enter project name'"
                 [innerText]="field.value || ''">
            </div>

            <input *ngSwitchCase="'text'" type="text" [(ngModel)]="field.value"
                   class="form-input" [style.min-width.px]="field.width"
                   [placeholder]="field.placeholder || ''" />

            <input *ngSwitchCase="'number'" type="number" [(ngModel)]="field.value"
                   class="form-input" [style.min-width.px]="field.width"
                   [placeholder]="field.placeholder || ''" />

            <input *ngSwitchCase="'tel'" type="tel" [(ngModel)]="field.value"
                   class="form-input" [style.min-width.px]="field.width"
                   [placeholder]="field.placeholder || ''" />

            <select *ngSwitchCase="'branch'" [(ngModel)]="field.value"
                    class="form-input" [style.min-width.px]="field.width">
              <option *ngFor="let option of field.options || []" [value]="option.value">
                {{ option.label }}
              </option>
            </select>

            <textarea *ngSwitchCase="'textarea'" [(ngModel)]="field.value"
                      class="form-input" [style.min-width.px]="field.width"
                      [placeholder]="field.placeholder || ''"></textarea>

            <div *ngSwitchCase="'signature'" class="signature-pad-container form-input"
                 [style.min-width.px]="field.width" style="position: relative;">
              <canvas #canvasElement [style.width.px]="field.width" height="100"
                      (pointerdown)="startDrawing($event, i)"
                      (pointermove)="draw($event, i)"
                      (pointerup)="stopDrawing($event, i)"
                      (pointerleave)="stopDrawing($event, i)"
                      style="border: 1px solid #ccc; touch-action: none;"></canvas>
              <button mat-fab matTooltip="Clear signature" aria-label="Clear signature"
                      class="clear-sign-btn" (click)="clearCanvas(i)"
                      style="position: absolute; top: 5px; right: 5px; z-index: 10;">
                <mat-icon>clear</mat-icon>
              </button>
            </div>

            <input *ngSwitchCase="'id'" type="text" disabled class="form-input"
                   [style.min-width.px]="field.width" placeholder="ID Field (readonly)" />

            <input *ngSwitchCase="'date'" type="date" [(ngModel)]="field.value"
                   class="form-input" [style.min-width.px]="field.width" />

            <input *ngSwitchCase="'email'" type="email" [(ngModel)]="field.value"
                   class="form-input" [style.min-width.px]="field.width"
                   [placeholder]="field.placeholder || ''" />

            <div *ngSwitchCase="'radio'" class="form-input" [style.min-width.px]="field.width">
              <label *ngFor="let option of field.options || []" style="margin-right: 8px;">
                <input type="radio" [name]="'radio-' + i" [value]="option.value"
                       [(ngModel)]="field.value" />
                {{ option.label }}
              </label>
            </div>

            <input *ngSwitchCase="'file'" type="file" class="form-input"
                   [style.min-width.px]="field.width" />

            <div *ngSwitchCase="'empty'" [style.min-width.px]="field.width"
                 style="height: 40px; border: 1px dashed #ccc;"></div>

            <button *ngSwitchCase="'submit'" mat-raised-button color="primary"
                    (click)="onSubmit()">
              {{ field.label || 'Submit' }}
            </button>

            <div *ngSwitchDefault>
              Unsupported field type: {{ field.type }}
            </div>

          </ng-container>

          <button title="Remove field" mat-fab aria-label="Remove field"
                  (click)="removeField(currentPage, field)" class="delete-btn">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Field Configuration Popup -->
<div *ngIf="fieldConfigVisible" class="popup-overlay mat-dialog-overlay">
  <div class="popup mat-elevation-z4">
    <h3 class="form-title">Configure Field</h3>
    <form (ngSubmit)="createField()" class="field-form" #form="ngForm">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Label</mat-label>
        <input matInput [(ngModel)]="newField.label" name="label" required />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Placeholder</mat-label>
        <input matInput [(ngModel)]="newField.placeholder" name="placeholder" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Width</mat-label>
        <mat-select [(ngModel)]="newField.width" name="width">
          <mat-option value="150">Small</mat-option>
          <mat-option value="300">Medium</mat-option>
          <mat-option value="400">Large</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="action-buttons">
        <button mat-raised-button color="primary" type="submit">Create</button>
        <button mat-button color="warn" type="button" (click)="cancelFieldConfig()">Cancel</button>
      </div>
    </form>
  </div>
</div>