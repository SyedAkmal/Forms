
<div class="form-builder-wrapper">
  <!-- Top Section -->
  <div class="top-section">
    <h2>Form Builder</h2>
    <div class="top-actions">
      <button mat-raised-button color="primary" (click)="backToDashboard()">Back to Dashboard</button>
      <button mat-raised-button color="primary" (click)="saveForm()">Save </button>
  <button mat-raised-button color="primary" (click)="openNewTemplate()">Template</button>
      <button mat-raised-button color="primary" (click)="exportToPDF()">Save as PDF</button>
      <button mat-raised-button color="accent" (click)="loadSavedFormsList()">Load Saved Templates</button>
   <button mat-raised-button color="accent"
        (click)="saveFilledForm()"
        [disabled]="hasRequiredMissing()">
  Save Filled Form
</button>
    </div>
  </div>


  <!-- Saved Forms List -->
 <mat-card class="saved-forms-card" *ngIf="formListVisible">
  <div class="card-header">
    <h2>Saved Forms</h2>
    <span class="spacer"></span>

       <!-- Viewing filter -->
     <mat-form-field appearance="outline" style="min-width:180px;">
    <mat-label>Viewing</mat-label>
    <mat-select [(ngModel)]="listBranchFilter">
      <mat-option value="ALL">All Branches</mat-option>
<ng-container *ngFor="let b of branches">
  <mat-option *ngIf="b !== 'ALL'" [value]="b">{{ b }}</mat-option>
</ng-container>
    </mat-select>
  </mat-form-field>
</div>

<div class="table-wrap" *ngIf="formListVisible">
    <!-- ✅ SINGLE table; use the FILTERED datasource -->
    <table mat-table [dataSource]="filteredSavedForms" class="mat-elevation-z2 saved-forms-table">

    <!-- Template -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef> Template </th>
      <td mat-cell *matCellDef="let f">
        <div class="template-cell" [title]="f.formName">{{ f.formName }}</div>
      </td>
    </ng-container>

    <!-- Visible In (selector) -->
    <ng-container matColumnDef="visibleIn">
      <th mat-header-cell *matHeaderCellDef> Visible In </th>
      <td mat-cell *matCellDef="let f">
        <mat-form-field appearance="outline" class="compact-select">
          <mat-select
            multiple
            [(ngModel)]="f._uiSelection"
            name="branch-{{f.formId}}"
            (ngModelChange)="onTemplateBranchesChange(f, $event)"
               [disabled]="!canManageAllBranches"   >
            <mat-option *ngFor="let b of branches" [value]="b">
              {{ b === 'ALL' ? 'All Branches' : b }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </td>
    </ng-container>

    <!-- Current (chips) -->
    <ng-container matColumnDef="current">
      <th mat-header-cell *matHeaderCellDef> Current </th>
      <td mat-cell *matCellDef="let f">
        <div class="chip-row">
          <span class="chip" *ngFor="let b of displayBranches(f)">{{ b }}</span>
        </div>
      </td>
    </ng-container>

    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let f" class="actions-cell">
        <button mat-icon-button color="warn" (click)="deleteForm(f)" matTooltip="Delete">
          <mat-icon>delete</mat-icon>
        </button>
        <button mat-icon-button color="primary" (click)="openForm(f)" matTooltip="Edit">
          <mat-icon>edit</mat-icon>
        </button>
      </td>
    </ng-container>

    <!-- Row defs (no trailing semicolon in microsyntax) -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns" class="sticky"></tr>
<tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackBySavedForm"></tr>

    <!-- Proper “no data” row for MatTable -->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell" [attr.colspan]="displayedColumns.length">
        No templates yet. Click <strong>Template</strong> to create one.
      </td>
    </tr>
</table>
</div>

</mat-card>

 <button mat-button color="primary"
          (click)="formListVisible=false; formBuilderVisible=true">
    Back to Form Builder
  </button>


 

  <!-- Form Builder -->
  <div *ngIf="formBuilderVisible" class="form-builder"
   style="display:flex; flex-direction:column; height:100vh; overflow:hidden;">
    <div class="main-content" cdkDropListGroup style="display:flex;align-items:stretch; width:100%; gap:16px; box-sizing:border-box;">

      <!-- Field Palette -->
      <div class="field-palette" cdkDropList id="fieldPalette"
           [cdkDropListData]="paletteFields"
           [cdkDropListConnectedTo]="['formCanvas']"
           (cdkDropListDropped)="onDrop($event)"
           style="width:200px; min-width:180px; border:1px solid #ccc; padding:8px; box-sizing:border-box;">
        <h3>Field Palette</h3>
        <div *ngFor="let field of paletteFields"
             class="field-item"
             cdkDrag
             [cdkDragData]="field"
             (cdkDragMoved)="onDragMoved($event)">
          <ng-container *cdkDragPreview>
            <div class="drag-preview">{{ field.label }}</div>
          </ng-container>
          {{ field.label }}
        </div>
      </div>

      <!-- Canvas -->
      <div class="form-canvas" cdkDropList id="formCanvas"
           (cdkDropListDropped)="onDrop($event)"
           [cdkDropListConnectedTo]="['fieldPalette']"
           [cdkDropListData]="formPages[currentPage].fields"
        style="position:relative; flex:1; height:100%; min-height:0; border:1px solid #ddd; padding:8px;
            padding-bottom:240px; /* 👈 real space */
            box-sizing:border-box; overflow:auto;
            scroll-padding-bottom:240px;">
         

        <!-- Render Fields -->
        <div *ngFor="let field of formPages[currentPage].fields; let i = index; trackBy: trackByFieldId"
             cdkDrag
             [cdkDragData]="field"
             [cdkDragFreeDragPosition]="field.position || { x: 0, y: 0 }"
            [attr.cdkDragBoundary]="'#formCanvas'"
             (cdkDragStarted)="onFieldDragStarted($event, field)"
             (cdkDragMoved)="onFieldDragMoved($event, field)"
             (cdkDragEnded)="onFieldDragEnded($event, field)"
             [cdkDragDisabled]="labelEditing === field.id" 
             class="form-row"
             [style.maxWidth]="(field.type==='textarea' && (field.id==='description' || field.label==='Description Field')) ? 'none' : null"
             [style.maxHeight]="(field.type==='textarea' && (field.id==='description' || field.label==='Description Field')) ? 'none' : null"
             [ngStyle]="{ left: field.position?.x + 'px', top: field.position?.y + 'px', width: field.width + 'px', height: field.height + 'px' }"
             style="position:absolute; cursor:move; padding:8px; border:1px solid #ccc; background:#fafafa;"
             [class.textarea-row]="field.type === 'textarea' || field.type === 'description'">

          <!-- Header / Drag handle -->
          <div class="field-header" style="display:flex; justify-content:space-between; align-items:center;">
            <div cdkDragHandle class="drag-handle" style="cursor:move; font-size:18px;">☰</div>
          </div>

          <!-- Label (if not a title/empty) -->
        <div *ngIf="field.label && field.type !== 'project-title' && field.type !== 'empty' && field.type !== 'checkbox'  && field.type !== 'radio'"
     style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
<label class="form-label" [attr.for]="'field-' + i" style="margin:0;"
       [attr.aria-required]="isRequiredField(field) ? 'true' : null">
  {{ field.label }}
  <span *ngIf="isRequiredField(field)" aria-hidden="true" style="color:#d32f2f;">*</span>
</label>

  <!-- Add button shown ONLY for the Description textarea -->
  <button *ngIf="field.type === 'textarea' && (field.id === 'description' || field.label === 'Description Field')"
          mat-stroked-button type="button" (click)="addProblemItem(field)">
    <mat-icon>add</mat-icon>
    Add
  </button>
</div>

          <!-- Field content by type -->
          <ng-container [ngSwitch]="field.type">

            <!-- Project Title -->
            <div *ngSwitchCase="'project-title'" contenteditable="true" class="form-input editable-div"
                 (input)="onContentEditableInput($event, field)" [attr.aria-label]="'Project Name'" spellcheck="false"
                 [ngClass]="{'has-value': field.value}">
              <span *ngIf="!field.value" class="placeholder">Enter project name</span>
            </div>

            <!-- Text -->
            <input *ngSwitchCase="'text'" id="field-{{i}}" name="field-{{i}}" type="text"
                   [(ngModel)]="field.value" class="form-input" [style.width.px]="field.width" [placeholder]="field.placeholder || ''" />

            <!-- Number -->
            <input *ngSwitchCase="'number'" id="field-{{i}}" name="field-{{i}}" type="number"
                   [(ngModel)]="field.value" class="form-input" [style.width.px]="field.width" [placeholder]="field.placeholder || ''" />

            <!-- Tel -->
            <input *ngSwitchCase="'tel'" id="field-{{i}}" name="field-{{i}}" type="tel"
                   [(ngModel)]="field.value" class="form-input" [style.width.px]="field.width" [placeholder]="field.placeholder || ''" />

            <!-- Email -->
            <input *ngSwitchCase="'email'" id="field-{{i}}" name="field-{{i}}" type="email"
                   [(ngModel)]="field.value" class="form-input" [style.width.px]="field.width" [placeholder]="field.placeholder || ''" />

            <!-- ID (readonly) -->
            <input *ngSwitchCase="'id'" id="field-{{i}}" name="field-{{i}}" type="text" class="form-input"
                   [style.width.px]="field.width" [value]="field.id" disabled placeholder="ID Field (readonly)" />

<div *ngSwitchCase="'checkbox'"
     class="checkbox-field"
     [style.width.px]="field.width"
     style="display:flex; flex-direction:column; gap:8px;">

  <!-- Inline editable group title (no separate heading) -->
  <div style="display:flex; align-items:center; gap:8px;">
    <span class="editable-label"
          [attr.data-id]="field.id"
          contenteditable="true"
          (focus)="startLabelEdit(field, $event)"
          (blur)="finishLabelEdit(field, $event)"
          (keydown)="onLabelKeydown(field, $event)"
          style="outline:0; border-bottom:1px dashed transparent;"
          [style.borderBottomColor]="labelEditing===field.id ? '#999' : 'transparent'">
      {{ field.label || 'Checkbox' }}
    </span>
    <span *ngIf="isRequiredField(field)" aria-hidden="true" style="color:#d32f2f;">*</span>
  </div>

  <!-- Multiple checkboxes from options -->
     <div class="checkbox-options-row"
         style="display:flex; flex-wrap:wrap; align-items:center; column-gap:24px; row-gap:8px;">
  <label *ngFor="let opt of (field.options || []); let oi = index"
        style="display:inline-flex; align-items:center; gap:6px; width:auto; margin:0; white-space:nowrap;">
    <input type="checkbox" [(ngModel)]="opt.checked">
    <span contenteditable="true"
        (blur)="onOptionLabelBlur($event, oi, opt)"
          style="outline:0;">
      {{ opt.label || ('Option ' + (oi+1)) }}
    </span>
  </label>
  </div>

  <!-- Single required message -->
<div *ngIf="isRequiredField(field) && !hasAnyChecked(field)"
     style="color:#d32f2f; font-size:12px;">
  * Required: select at least one option.
</div>
</div>


            <!-- Date -->
            <input *ngSwitchCase="'date'" id="field-{{i}}" name="field-{{i}}" type="date"
                   [(ngModel)]="field.value" class="form-input" [style.width.px]="field.width" />
                   <div *ngIf="isRequiredField(field) && !isFieldFilled(field)"
     style="color:#d32f2f; font-size:12px; margin-top:4px;">
  * Required: please select {{ field.label || 'Date' }}.
</div>

            <!-- Branch select -->
            <select *ngSwitchCase="'branch'" id="field-{{i}}" name="field-{{i}}" [(ngModel)]="field.value"
                    class="form-input" [style.width.px]="field.width">
              <option *ngFor="let option of field.options || []" [value]="option.value">{{ option.label }}</option>
            </select>
<!-- Textarea (normal) + Description (numbered items) -->
<div *ngSwitchCase="'textarea'" style="width:100%;">
  <!-- Description mode -->
  <ng-container *ngIf="field.id === 'description' || field.label === 'Description Field'; else normalTextarea">
   <div class="desc-list" style="display:flex;flex-direction:column;gap:6px;">
      <div class="desc-row"
           *ngFor="let item of (field.problemItems || []); let i = index"
           style="display:flex;align-items:center;gap:8px;">
        <span class="desc-no" style="width:24px;text-align:right;">{{ item.no }}.</span>

        <textarea class="desc-input"
                  [ngModel]="item.text"
                  (ngModelChange)="updateProblemText(field, i, $event)"
                  placeholder="Write problem description..."
                 style="flex:0 0 auto; min-width:160px; max-width:none; min-height:40px;
       padding:4px; border:1px solid #ccc; border-radius:4px;
       resize:both; overflow:auto;">
                </textarea>

        <button mat-icon-button type="button" (click)="removeProblemItem(field, i)" aria-label="Remove">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </ng-container>

  <!-- Normal textarea fallback -->
  <ng-template #normalTextarea>
    <div class="textarea-container" style="display:flex;align-items:stretch;gap:8px;width:100%;">
   <textarea
  [(ngModel)]="field.value"
  [name]="field.id"
  [id]="field.id"

  #textareaRef="ngModel"
  class="textarea-resizable-both"
  [ngClass]="{'desc-fill': field.type === 'textarea' && (field.id === 'description' || field.label === 'Description Field')}"
  [attr.aria-describedby]="field.id + '-error'"
  [placeholder]="field.placeholder || ''"
  style="min-height:60px"></textarea>
    </div>
  </ng-template>
</div>
      <!--Radio-->
<div *ngSwitchCase="'radio'" class="radio-field" [style.width.px]="field.width">
  <!-- Group title (same editable header you use in checkbox) -->
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
    <span class="editable-label"
          [attr.data-id]="field.id"
          contenteditable="true"
          (focus)="startLabelEdit(field, $event)"
          (blur)="finishLabelEdit(field, $event)"
          (keydown)="onLabelKeydown(field, $event)"
          style="outline:0;">
      {{ field.label || 'Radio Field' }}
    </span>
    <span *ngIf="isRequiredField(field)" style="color:#d32f2f;">*</span>
  </div>

  <!-- Inline options row (exactly like checkbox) -->
  <div class="radio-options-row"
       style="display:flex; flex-wrap:wrap; align-items:center; column-gap:24px; row-gap:8px;">
    <label *ngFor="let opt of (field.options || []); let i = index"
           style="display:inline-flex; align-items:center; gap:6px; width:auto; margin:0; white-space:nowrap;">
      <input type="radio"
             [name]="field.id"
             [value]="opt.value || ('opt' + (i+1))"
             [(ngModel)]="field.value"
             [ngModelOptions]="{standalone:true}">
      <span contenteditable="true"
            (mousedown)="$event.preventDefault(); $event.stopPropagation()"
            (click)="$event.preventDefault(); $event.stopPropagation()"
            (keydown)="onOptionKeydown($event)"
            (blur)="onOptionLabelBlur($event, i, opt)"
            style="outline:0;">
        {{ opt.label || ('Option ' + (i+1)) }}
      </span>
    </label>
  </div>

  <!-- Required message -->
  <div *ngIf="field.required && !field.value"
       style="color:#d32f2f; font-size:12px; margin-top:4px;">
    * Required: select one option.
  </div>
</div>


            <!-- File upload -->
            <div *ngSwitchCase="'file'" style="margin-top:8px; position:relative;">
              <input type="file" accept="image/*" (change)="onFileSelected($event, field)" />
              <div *ngIf="field.value" style="margin-top:8px;">
                <img [src]="field.value" alt="Uploaded Image" style="max-width:200px; max-height:200px; border:1px solid #ccc; border-radius:4px;" />
              </div>
            </div>

            <!-- Empty / Spacer with editable label -->
            <div *ngSwitchCase="'empty'" [style.width.px]="field.width" class="resizable-container" style="border:1px dashed #ccc;">
              <div contenteditable="true" (input)="onEmptyLabelInput($event, field)"
                   style="width:100%; min-height:24px; outline:none; font-weight:bold; color:#555;">
                {{ field.label || 'Spacer / Heading (click to edit)' }}
              </div>
            </div>

            <!-- Submit button -->
           <button *ngSwitchCase="'submit'" mat-raised-button color="primary"
        (click)="onSubmit()"
        [disabled]="hasRequiredMissing()">
  {{ field.label || 'Submit' }}
</button>

            <!-- Signature pad -->
            <div *ngSwitchCase="'signature'" class="signature-pad-container form-input" [style.width.px]="field.width" style="position:relative;">
              <canvas #canvasElement [attr.data-id]="field.id" [attr.width]="field.width || 300" [attr.height]="150"
                      [style.width.px]="field.width || 300" [style.height.px]="150" aria-label="Signature Pad"></canvas>

              <button mat-fab class="clear-sign-btn" aria-label="Clear signature"
                      style="position:absolute; top:5px; right:45px; z-index:10;"
                      (click)="clearSignatureCanvas(field.id); $event.stopPropagation()">
                <mat-icon>clear</mat-icon>
              </button>
            </div>
            <div *ngIf="isRequiredField(field) && !isFieldFilled(field)"
     style="color:#d32f2f; font-size:12px; margin-top:4px;">
  * Required: please sign in the box.
</div>

            <!-- Table placeholder -->
            <div *ngSwitchCase="'table'" class="table-container" [style.width.px]="field.width || 400"
                 style="border:1px solid #ccc; padding:8px; overflow-x:auto;">
              <table style="border-collapse:collapse; width:100%;">
                <tbody>
                  <tr *ngFor="let row of [1,2,3,4]">
                    <td *ngFor="let col of [1,2,3,4]" style="border:1px dashed #999; width:80px; height:40px;"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Fallback -->
            <div *ngSwitchDefault>Unsupported field type: {{ field.type }}</div>
          </ng-container>

          <div class="rh rh-n"  (mousedown)="startResize($event, field, true,  true, 'n')"></div>
  <div class="rh rh-s"  (mousedown)="startResize($event, field, true,  true, 's')"></div>
  <div class="rh rh-e"  (mousedown)="startResize($event, field, true,  true, 'e')"></div>
  <div class="rh rh-w"  (mousedown)="startResize($event, field, true,  true, 'w')"></div>

  <!-- Inner resize handles (corners) -->
  <div class="rh rh-ne" (mousedown)="startResize($event, field, true,  true, 'ne')"></div>
  <div class="rh rh-nw" (mousedown)="startResize($event, field, true,  true, 'nw')"></div>
  <div class="rh rh-se" (mousedown)="startResize($event, field, true,  true, 'se')"></div>
  <div class="rh rh-sw" (mousedown)="startResize($event, field, true,  true, 'sw')"></div>

  <!-- Delete button (unchanged) -->
  <button (click)="removeField(currentPage, field); $event.stopPropagation()" class="delete-button" title="Delete field"
          style="color:red; font-size:20px; border:none; background:transparent; cursor:pointer; position:absolute; top:4px; right:4px;">
    &times;
  </button>
</div>

        <!-- Field Config Modal -->
        <div *ngIf="fieldConfigVisible" class="popup-overlay">
          <div class="popup mat-elevation-z4" (click)="$event.stopPropagation()">
            <h3 class="form-title">Configure Field</h3>
            <form (ngSubmit)="createField()" #form="ngForm" class="field-form">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Label</mat-label>
                <input matInput [(ngModel)]="newField.label" name="label" required #labelCtrl="ngModel" />
                <div *ngIf="labelCtrl.invalid && (labelCtrl.dirty || labelCtrl.touched)" class="error-msg" style="color:red;">
                  Label is required.
                </div>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Placeholder</mat-label>
                <input matInput [(ngModel)]="newField.placeholder" name="placeholder" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Width</mat-label>
                <mat-select [(ngModel)]="newField.width" name="width">
                  <mat-option [value]="150">Small</mat-option>
                  <mat-option [value]="300">Medium</mat-option>
                  <mat-option [value]="400">Large</mat-option>
                </mat-select>
              </mat-form-field>
   <mat-checkbox [(ngModel)]="newField.required" name="required">
  Required
</mat-checkbox>

              <div class="action-buttons">
                <button mat-raised-button color="primary" type="submit">Create</button>
                <button mat-button color="warn" type="button" (click)="cancelFieldConfig()">Cancel</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>

      <!-- Page Navigation (Right) -->
       <!-- Bottom pager (sticky) -->
    <div class="pager-bar" style="display:flex; align-items:center; gap:12px; padding:10px 16px; border-top:1px solid #e5e7eb; background:#fff; position:sticky; bottom:0; z-index:10;">
      <button mat-button color="primary" (click)="prevPage()" [disabled]="currentPage === 0">Previous</button>
      <span class="pager-info" style="font-weight:600; color:#374151;">Page {{ currentPage + 1 }} of {{ formPages.length }}</span>
      <span class="spacer" style="flex:1 1 auto;"></span>
      <button mat-stroked-button color="accent" (click)="addNewPage()">Add New Page</button>
      <button mat-button color="primary" (click)="nextPage()" [disabled]="currentPage >= formPages.length - 1">Next</button>
    </div>

  </div>
</div>
